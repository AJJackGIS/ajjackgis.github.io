<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>咖啡GIS的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="咖啡GIS的个人博客">
<meta property="og:url" content="http://www.kfgis.site/blog/index.html">
<meta property="og:site_name" content="咖啡GIS的个人博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="咖啡GIS的个人博客">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">咖啡GIS的个人博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">所有文章</a>
        
        <a class="main-nav-link" href="./works">作品</a>
      </nav>
      <nav id="sub-nav">
        
        
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.kfgis.site/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-celiang" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/celiang/" class="article-date">
  <time datetime="2019-10-08T10:18:53.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/celiang/">Cesium-测量</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Cesium 是一款面向三维地球和地图的，世界级的JavaScript开源产品。它提供了基于JavaScript语言的开发包，方便用户快速搭建一款零插件的虚拟地球Web应用，并在性能，精度，渲染质量以及多平台，易用性上都有高质量的保证。 </p>
<h2 id="关于测量"><a href="#关于测量" class="headerlink" title="关于测量"></a>关于测量</h2><hr>
<p>测量是一个GIS系统最基本的，也是必备的模块，网上也有很多相关开发者分享过关于Cesium测量的技术文章，风格各异，但是大同小异，只要弄清楚了原理以及方法，其实每个人都可以写出自己的测量小工具。</p>
<h2 id="测距"><a href="#测距" class="headerlink" title="测距"></a>测距</h2><hr>
<p>测距其实计算两点之间的距离，这个计算方法可以使用最原始的直角三角形求斜边的方法，但是我们也可以直接使用Cesium中Cartesian3接口的distance方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cesium.Cartesian3.distance(firstPoint, secondPoint);</span><br></pre></td></tr></table></figure>

<p>计算方法已经有了，我们要做的就是添砖加瓦，做成一个可供用户交互的测距，并且实时显示距离长度的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标左击事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (clickEvent) &#123;</span><br><span class="line">	var cartesian = viewer.scene.pickPosition(clickEvent.position);</span><br><span class="line">	// 如果是第一次点击</span><br><span class="line">	if (positions.length == 0) &#123;</span><br><span class="line">		addPoint(cartesian); // 存储第一个点，并在点击处绘制一个点entity</span><br><span class="line">		// 同时注册鼠标移动事件</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		addPoint(cartesian); // 存储第二个点，并在点击处绘制一个点entity，测量结束，注销所有的鼠标注册事件</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标移动事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (moveEvent) &#123;</span><br><span class="line">	var movePosition = viewer.scene.pickPosition(moveEvent.endPosition); // 鼠标移动的点</span><br><span class="line">	if (positions.length == 1) &#123;</span><br><span class="line">		// 存储第二个点</span><br><span class="line">		positions.push(movePosition);</span><br><span class="line">		// 绘制线</span><br><span class="line">		addLine(positions);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		positions.pop(); // 移除上次鼠标经过的点</span><br><span class="line">		positions.push(movePosition); // 存储这次鼠标经过的点</span><br><span class="line">		// 计算中点</span><br><span class="line">		var centerPoint = Cesium.Cartesian3.midpoint(positions[0], positions[1], new Cesium.Cartesian3());</span><br><span class="line">		// 计算距离</span><br><span class="line">		var lengthText = &quot;距离：&quot; + getLengthText(positions[0], positions[1]);</span><br><span class="line">		// 绘制距离长度标签</span><br><span class="line">		labelEntity = addLabel(centerPoint, lengthText);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.MOUSE_MOVE);</span><br></pre></td></tr></table></figure>

<h2 id="测面"><a href="#测面" class="headerlink" title="测面"></a>测面</h2><hr>
<p>测面积，也就是计算至少三个点构成的任意多边形的面积，可以使用拆分三角曲面的方法计算每一个小三角形的面积，然后累加得到任意多边形的面积。由于多边形点的个数是至少3个，所以我们还要比测距多一个结束注册事件，可以双击结束，也可以右击结束。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标左击事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (clickEvent) &#123;</span><br><span class="line">	var cartesian = viewer.scene.pickPosition(clickEvent.position);</span><br><span class="line">	if (positions.length == 0) &#123;</span><br><span class="line">		positions.push(cartesian.clone()); //鼠标左击 添加第1个点</span><br><span class="line">		addPoint(cartesian);</span><br><span class="line">		// 注册鼠标移动事件</span><br><span class="line">	&#125; else if (positions.length == 2) &#123;</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.push(cartesian.clone()); // 鼠标左击 添加第2个点</span><br><span class="line">		addPoint(cartesian);</span><br><span class="line">		addPolyGon(positions); // 绘制面</span><br><span class="line">		// 注册鼠标右击结束事件</span><br><span class="line"></span><br><span class="line">	&#125; else if (positions.length &gt;= 3) &#123;</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.push(cartesian.clone()); // 鼠标左击 添加第3个点</span><br><span class="line">		addPoint(cartesian);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标移动事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (moveEvent) &#123;</span><br><span class="line">	var movePosition = viewer.scene.pickPosition(moveEvent.endPosition);</span><br><span class="line">	if (positions.length == 1) &#123;</span><br><span class="line">		positions.push(movePosition);</span><br><span class="line">		addLine(positions);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.push(movePosition);</span><br><span class="line">	&#125;</span><br><span class="line">	if (positions.length &gt;= 3) &#123;</span><br><span class="line">		var text = &quot;面积：&quot; + getArea(positions);</span><br><span class="line">		// 获取面积的重心</span><br><span class="line">		var centerPoint = getCenterOfGravityPoint(positions);</span><br><span class="line">		// 绘制label</span><br><span class="line">		addLabel(centerPoint, text);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.MOUSE_MOVE);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标右击结束事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (clickEvent) &#123;</span><br><span class="line"></span><br><span class="line">	var clickPosition = viewer.scene.pickPosition(clickEvent.position);</span><br><span class="line">	positions.pop();</span><br><span class="line">	positions.push(clickPosition);</span><br><span class="line">	positions.push(positions[0]); // 闭合</span><br><span class="line">	addPoint(clickPosition);</span><br><span class="line"></span><br><span class="line">	// 解除注册的事件</span><br><span class="line"></span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.RIGHT_CLICK);</span><br></pre></td></tr></table></figure>

<h2 id="测高"><a href="#测高" class="headerlink" title="测高"></a>测高</h2><hr>
<p>测高即是在测距的基础上，计算两个点之间的空间高度，这个是对测距的一个功能扩展。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标左击事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (clickEvent) &#123;</span><br><span class="line">	var cartesian = viewer.scene.pickPosition(clickEvent.position); // 坐标</span><br><span class="line"></span><br><span class="line">	// 存储第一个点</span><br><span class="line">	if (positions.length == 0) &#123;</span><br><span class="line">		positions.push(cartesian.clone());</span><br><span class="line">		addPoint(cartesian);</span><br><span class="line">		// 注册鼠标移动事件</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		// 存储第二个点</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.pop();</span><br><span class="line">		var cartographic = Cesium.Cartographic.fromCartesian(cartesian);</span><br><span class="line">		var height = Cesium.Cartographic.fromCartesian(positions[0]).height;</span><br><span class="line">		// 得到辅助点</span><br><span class="line">		var verticalPoint = Cesium.Cartesian3.fromDegrees(Cesium.Math.toDegrees(cartographic.longitude), Cesium.Math.toDegrees(cartographic.latitude), height);</span><br><span class="line">		positions.push(verticalPoint);</span><br><span class="line">		positions.push(cartesian);</span><br><span class="line">		positions.push(positions[0]);</span><br><span class="line">		addPoint(cartesian);</span><br><span class="line">		// 移除所有注册的事件</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// 注册鼠标移动事件</span><br><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (moveEvent) &#123;</span><br><span class="line">	var movePosition = viewer.scene.pickPosition(moveEvent.endPosition); // 鼠标移动的点</span><br><span class="line">	if (positions.length &gt;= 2) &#123;</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.pop();</span><br><span class="line">		positions.pop();</span><br><span class="line"></span><br><span class="line">		var cartographic = Cesium.Cartographic.fromCartesian(movePosition);</span><br><span class="line">		var height = Cesium.Cartographic.fromCartesian(positions[0]).height;</span><br><span class="line"></span><br><span class="line">		// 辅助点</span><br><span class="line">		var verticalPoint = Cesium.Cartesian3.fromDegrees(Cesium.Math.toDegrees(cartographic.longitude), Cesium.Math.toDegrees(cartographic.latitude), height);</span><br><span class="line">		positions.push(verticalPoint);</span><br><span class="line">		positions.push(movePosition);</span><br><span class="line">		positions.push(positions[0]);</span><br><span class="line"></span><br><span class="line">		// 计算中点</span><br><span class="line">		var centerPoint_1 = Cesium.Cartesian3.midpoint(positions[0], positions[1], new Cesium.Cartesian3());</span><br><span class="line">		// 计算距离</span><br><span class="line">		var lengthText_1 = &quot;水平距离：&quot; + getLengthText(positions[0], positions[1]);</span><br><span class="line"></span><br><span class="line">		addLabel(centerPoint_1, lengthText_1);</span><br><span class="line"></span><br><span class="line">		// 计算中点</span><br><span class="line">		var centerPoint_2 = Cesium.Cartesian3.midpoint(positions[1], positions[2], new Cesium.Cartesian3());</span><br><span class="line">		// 计算距离</span><br><span class="line">		var lengthText_2 = &quot;垂直距离：&quot; + getLengthText(positions[1], positions[2]);</span><br><span class="line"></span><br><span class="line">		addLabel(centerPoint_2, lengthText_2);</span><br><span class="line"></span><br><span class="line">		// 计算中点</span><br><span class="line">		var centerPoint_3 = Cesium.Cartesian3.midpoint(positions[2], positions[3], new Cesium.Cartesian3());</span><br><span class="line">		// 计算距离</span><br><span class="line">		var lengthText_3 = &quot;直线距离：&quot; + getLengthText(positions[2], positions[3]);</span><br><span class="line"></span><br><span class="line">		addLabel(centerPoint_3, lengthText_3);</span><br><span class="line"></span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		var verticalPoint = new Cesium.Cartesian3(movePosition.x, movePosition.y, positions[0].z);</span><br><span class="line">		positions.push(verticalPoint);</span><br><span class="line">		positions.push(movePosition);</span><br><span class="line">		positions.push(positions[0]);</span><br><span class="line">		// 绘制线</span><br><span class="line">		addLine(positions);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.MOUSE_MOVE);</span><br></pre></td></tr></table></figure>

<p>##注意</p>
<hr>
<p>当然，上面给出的代码只是思路性的代码，其中还有一些要注意的，比如Entity和Label的显示控制啊，Polyline、Polygon、以及Point的动态刷新实时绘制，还有所有entity的在viewer容器中的控制等等，需要进一步完善。</p>
<p><strong>补充</strong>：本来这篇文章只是想给一个测量思路，由于太多订阅者联系我，让我提供一下源码，所以，在这里还是把代码放出来，当然，如果遇到版本不兼容或者有功能性错误的，可以联系我。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.kfgis.site/blog/2019/10/08/celiang/" data-id="ck1hpqo1d0003rok8rwrv4c79" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cesium/">Cesium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/测量/">测量</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-poumianfenxi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/poumianfenxi/" class="article-date">
  <time datetime="2019-10-08T10:17:40.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/poumianfenxi/">Cesium-剖面分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Cesium 是一款面向三维地球和地图的，世界级的JavaScript开源产品。它提供了基于JavaScript语言的开发包，方便用户快速搭建一款零插件的虚拟地球Web应用，并在性能，精度，渲染质量以及多平台，易用性上都有高质量的保证。 </p>
<h2 id="剖面分析"><a href="#剖面分析" class="headerlink" title="剖面分析"></a>剖面分析</h2><hr>
<p>剖面分析从网上找不到比较合理的定义说明，最初是一种犯罪调差方法。</p>
<blockquote>
<p>Geographic profiling is a criminal investigative methodology that analyzes the locations of a connected series of crimes to determine the most probable area of offender residence. By incorporating both qualitative and quantitative methods, it assists in understanding spatial behaviour of an offender and focusing the investigation to a smaller area of the community.</p>
</blockquote>
<p>谷歌给的翻译是：</p>
<blockquote>
<p>地理概况分析是一种刑事调查方法，分析一系列相关犯罪的位置，以确定最可能的犯罪者居住区域。 通过结合定性和定量方法，它有助于理解罪犯的空间行为，并将调查重点放在社区的较小区域。</p>
</blockquote>
<p>简单的说，地理学上的剖面分析，是从其中一个维度去比较、衡量、分析一组样本的区别，然后定性、定量给出结论的一种分析方法，比如科学家们研究人类，从年龄这个维度可以把人归纳成幼儿、成人、老人等。</p>
<p>我们这里说的剖面分析更具体点，是从地形表面的高程这个维度去研究分析，比如环法自行车赛中每段比赛前展示的爬坡高度图。<br><img src="https://images.xiaozhuanlan.com/photo/2019/846809126dce44652c466fe758093781.jpg" alt></p>
<p><strong>效果图</strong><br><img src="https://images.xiaozhuanlan.com/photo/2019/9dfde213cd4b1c1c11a13b94a7e640d8.jpg" alt></p>
<h2 id="具体做法"><a href="#具体做法" class="headerlink" title="具体做法"></a>具体做法</h2><hr>
<p><strong>原理：采用采样法法来获取指定位置的地形高度</strong></p>
<p><strong>接口API</strong></p>
<ul>
<li>ScreenSpaceEventHandler</li>
<li>CallbackProperty</li>
<li>sampleTerrainMostDetailed</li>
<li>ClassificationType</li>
</ul>
<p><strong>具体步骤</strong></p>
<p>1.初始化cesium地球，并设置地形服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var terrainProvider = Cesium.createWorldTerrain();</span><br><span class="line">var viewer = new Cesium.Viewer(&apos;cesiumContainer&apos;, &#123;</span><br><span class="line">	terrainProvider: terrainProvider</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>2.指定要研究的区域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">viewer.camera.setView(&#123;</span><br><span class="line">	destination: new Cesium.Cartesian3(-548184.7982559408, 5512367.059463563, 3173625.2210259973),</span><br><span class="line">	orientation: &#123;</span><br><span class="line">		heading: 5.683499859605618,</span><br><span class="line">		pitch: -0.3430291183891061,</span><br><span class="line">		roll: 6.281444671468591</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.绘制剖面分析的起始点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">viewer.screenSpaceEventHandler.setInputAction(function (clickEvent) &#123;</span><br><span class="line">	if (start == null) &#123;</span><br><span class="line">		start = viewer.scene.pickPosition(clickEvent.position);</span><br><span class="line">		drawPoint(start);</span><br><span class="line">		viewer.screenSpaceEventHandler.setInputAction(function (moveEvent) &#123;</span><br><span class="line">			end = viewer.scene.pickPosition(moveEvent.endPosition);</span><br><span class="line">			drawLine();</span><br><span class="line">		&#125;, Cesium.ScreenSpaceEventType.MOUSE_MOVE);</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		end = viewer.scene.pickPosition(clickEvent.position);</span><br><span class="line">		drawPoint(end);</span><br><span class="line">		viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br><span class="line">		viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE);</span><br><span class="line">		profileAnalyse();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, Cesium.ScreenSpaceEventType.LEFT_CLICK);</span><br></pre></td></tr></table></figure>

<p>4.根据起始点进行剖面分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function profileAnalyse() &#123;</span><br><span class="line">	var positions = [Cesium.Cartographic.fromCartesian(start)];</span><br><span class="line">	// 插值100个点，点越多模拟越精确，但是效率会低</span><br><span class="line">	var count = 100;</span><br><span class="line">	for (var i = 1; i &lt; count; i++) &#123;</span><br><span class="line">		var cart = Cesium.Cartesian3.lerp(start, end, i / count, new Cesium.Cartesian3());</span><br><span class="line">		positions.push(Cesium.Cartographic.fromCartesian(cart));</span><br><span class="line">	&#125;</span><br><span class="line">	positions.push(Cesium.Cartographic.fromCartesian(end));</span><br><span class="line"></span><br><span class="line">	// 异步使用最精确的地形采样获取地形高度</span><br><span class="line">	var promise = Cesium.sampleTerrainMostDetailed(terrainProvider, positions);</span><br><span class="line">	Cesium.when(promise, function (updatedPositions) &#123;</span><br><span class="line"></span><br><span class="line">		// 处理返回的数据</span><br><span class="line">		var height = [];</span><br><span class="line">		for (var i = 0; i &lt; updatedPositions.length; i++) &#123;</span><br><span class="line">			height.push(updatedPositions[i].height); // 取得高程值</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// 绘制高程走势图</span><br><span class="line">		dom.style.display = &quot;block&quot;;</span><br><span class="line"></span><br><span class="line">		// 使用Echart等图表工具可视化</span><br><span class="line">		if (myChart == null) &#123;</span><br><span class="line">			myChart = echarts.init(dom);</span><br><span class="line">			initChart(height, false);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			initChart(height, true);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.使用Echart等图表工具绘制剖面图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">function initChart(height, isMerge) &#123;</span><br><span class="line">	var option = &#123;</span><br><span class="line">		title: &#123;</span><br><span class="line">			text: &apos;海拔走势图&apos;</span><br><span class="line">		&#125;,</span><br><span class="line">		tooltip: &#123;</span><br><span class="line">			trigger: &apos;axis&apos;,</span><br><span class="line">			axisPointer: &#123;</span><br><span class="line">				type: &apos;cross&apos;,</span><br><span class="line">				label: &#123;</span><br><span class="line">					backgroundColor: &apos;#6a7985&apos;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		legend: &#123;</span><br><span class="line">			data: [&apos;海拔走势图&apos;]</span><br><span class="line">		&#125;,</span><br><span class="line">		toolbox: &#123;</span><br><span class="line">			feature: &#123;</span><br><span class="line">				saveAsImage: &#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		grid: &#123;</span><br><span class="line">			left: &apos;3%&apos;,</span><br><span class="line">			right: &apos;4%&apos;,</span><br><span class="line">			bottom: &apos;3%&apos;,</span><br><span class="line">			containLabel: true</span><br><span class="line">		&#125;,</span><br><span class="line">		xAxis: [</span><br><span class="line">			&#123;</span><br><span class="line">				type: &apos;category&apos;,</span><br><span class="line">				boundaryGap: false</span><br><span class="line">			&#125;</span><br><span class="line">		],</span><br><span class="line">		yAxis: [</span><br><span class="line">			&#123;</span><br><span class="line">				type: &apos;value&apos;</span><br><span class="line">			&#125;</span><br><span class="line">		],</span><br><span class="line">		series: [</span><br><span class="line">			&#123;</span><br><span class="line">				name: &apos;海拔走势图&apos;,</span><br><span class="line">				type: &apos;line&apos;,</span><br><span class="line">				stack: &apos;总量&apos;,</span><br><span class="line">				label: &#123;</span><br><span class="line">					normal: &#123;</span><br><span class="line">						show: true,</span><br><span class="line">						position: &apos;top&apos;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				areaStyle: &#123;normal: &#123;&#125;&#125;,</span><br><span class="line">				data: height</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;;</span><br><span class="line">	myChart.setOption(option, isMerge);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.kfgis.site/blog/2019/10/08/poumianfenxi/" data-id="ck1hpqo190001rok8gjjs9emq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cesium/">Cesium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/剖面分析/">剖面分析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tongshifenxi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/tongshifenxi/" class="article-date">
  <time datetime="2019-10-08T10:15:58.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/tongshifenxi/">Cesium-通视分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Cesium 是一款面向三维地球和地图的，世界级的JavaScript开源产品。它提供了基于JavaScript语言的开发包，方便用户快速搭建一款零插件的虚拟地球Web应用，并在性能，精度，渲染质量以及多平台，易用性上都有高质量的保证。 </p>
<h2 id="通视分析"><a href="#通视分析" class="headerlink" title="通视分析"></a>通视分析</h2><hr>
<p>通视分析是指以某一点为观察点，研究某一区域通视情况的地形分析。利用DEM判断地形上任意两点之间是否可以互相可见的技术方法，分为视线通视分析和可视域分析，前者判断任意两点之间或者多点之间能否通视，后者对于给定的观察点，分析观察所覆盖的区域。</p>
<p>其中可视域是从一个或者多个观察的可以看见的地表范围。可视域分析是在栅格数据数据集上，对于给定的一个观察点，基于一定的相对高度，查找给定的范围内观察点所能通视覆盖的区域，也就是给定点的通视区域范围，分析结果是得到一个栅格数据集。在确定发射塔的位置、雷达扫描的区域、以及建立森林防火瞭望塔的时候，都会用到可视域分析。可视域分析在航海、航空以及军事方面有较为广泛的应用。</p>
<p><strong>本章节首先处理这两种分析中的较为简单的通视分析，即给定的任意两点之间是否可见。</strong></p>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="https://images.xiaozhuanlan.com/photo/2019/f11652a4c4bccdb5507728e5fb829af9.png" alt></p>
<h2 id="具体做法"><a href="#具体做法" class="headerlink" title="具体做法"></a>具体做法</h2><hr>
<p><strong>原理：采用射线法来判别两点之间是否有其他物体所遮挡（比如Entity、Primitive、Terrain、3DTiles等）</strong></p>
<p><strong>接口API</strong></p>
<ul>
<li>Cesium.Cesium3DTileset</li>
<li>Cesium.Cartesian3</li>
<li>Cesium.Ray</li>
<li>Cesium.Scene</li>
</ul>
<p><strong>具体步骤</strong><br>1.设置你自己的AccessToken，如果不用Ion上的网络资源可省略这步</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cesium.Ion.defaultAccessToken = &apos;xxxx&apos;;</span><br></pre></td></tr></table></figure>

<p>2.初始化容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var viewer = new Cesium.Viewer(&apos;cesiumContainer&apos;, &#123;</span><br><span class="line">    imageryProvider: new Cesium.UrlTemplateImageryProvider(&#123;</span><br><span class="line">        url: &apos;http://www.google.cn/maps/vt?lyrs=s@716&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;&apos;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>3.加载3dtiles模型，作为通视的模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var tileset = new Cesium.Cesium3DTileset(&#123;</span><br><span class="line">    url: &apos;http://localhost/demo/tileset.json&apos;,</span><br><span class="line">&#125;);</span><br><span class="line">viewer.scene.primitives.add(tileset);</span><br><span class="line">tileset.readyPromise.then(function (argument) &#123;</span><br><span class="line">    viewer.camera.flyToBoundingSphere(tileset.boundingSphere);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>4.指定观察点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 视域点 设置观察点所在的视点高度为100m</span><br><span class="line">var viewPoint = Cesium.Cartesian3.fromDegrees(x, y, 100);</span><br></pre></td></tr></table></figure>

<p>5.计算目标点</p>
<p>本例计算距离观察点距离1km外 45°至135°之间每间隔1°共计90个点的通视情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 目标点集合</span><br><span class="line">var destPoints = [];</span><br><span class="line">// 视域点和目标点的距离</span><br><span class="line">var radius = 1000; // 视距1000米</span><br><span class="line">// 计算45°和135°之间的目标点</span><br><span class="line">for (var i = 45; i &lt;= 135; i++) &#123;</span><br><span class="line">    // 度数转弧度</span><br><span class="line">    var radians = Cesium.Math.toRadians(i);</span><br><span class="line">    // 计算目标点</span><br><span class="line">    var toPoint = new Cesium.Cartesian3(viewPointWebMercator.x + radius * Math.cos(radians), viewPointWebMercator.y + radius * Math.sin(radians), 30);</span><br><span class="line">    destPoints.push(Cesium.Cartographic.toCartesian(toPoint.clone()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中viewPointWebMercator对象是Cesium.WebMercatorProjection对象的实例，用于经纬度坐标和大地坐标转换</p>
<p>6.创建Ray对象，进行射线交互（<strong>注：待3dtiles模型加载完毕后执行</strong>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for (var i = 0; i &lt; destPoints.length; i++) &#123;</span><br><span class="line">    // 计算射线的方向，目标点left 视域点right</span><br><span class="line">    var direction = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(destPoints[i], viewPoint, new Cesium.Cartesian3()), new Cesium.Cartesian3());</span><br><span class="line">    // 建立射线</span><br><span class="line">    var ray = new Cesium.Ray(viewPoint, direction);</span><br><span class="line">    var result = viewer.scene.pickFromRay(ray, objectsToExclude); // 计算交互点，返回第一个</span><br><span class="line">    showIntersection(result, destPoints[i], viewPoint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7.处理射线交互结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function showIntersection(result, destPoint, viewPoint) &#123;</span><br><span class="line">    // 如果是场景模型的交互点，排除交互点是地球表面</span><br><span class="line">    if (Cesium.defined(result) &amp;&amp; Cesium.defined(result.object)) &#123;</span><br><span class="line">        drawLine(result.position, viewPoint, Cesium.Color.GREEN); // 可视区域</span><br><span class="line">        drawLine(result.position, destPoint, Cesium.Color.RED); // 不可视区域</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        drawLine(viewPoint, destPoint, Cesium.Color.GREEN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="需要了解的"><a href="#需要了解的" class="headerlink" title="需要了解的"></a>需要了解的</h2><hr>
<p>1.Cesium.Ray 对象<br><img src="https://images.xiaozhuanlan.com/photo/2019/6809856295ac77f1c4e06bd522dd80fd.png" alt><br>origin 是观察点 direction为方向，计算方向要注意的是从目标点朝观察点的方向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 计算射线的方向，目标点left 视域点right</span><br><span class="line">var direction = Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(destPoints[i], viewPoint, new Cesium.Cartesian3()), new Cesium.Cartesian3());</span><br></pre></td></tr></table></figure>

<p>2.Scene.prototype.pickFromRay 方法的定义（API文档中没有，需要查看cesium源码）<br><img src="https://images.xiaozhuanlan.com/photo/2019/2f912013d05dd23e3aaf500fab762f43.png" alt><br>其中ray为上述的ray对象，objectsToExclude为可以过滤掉不用参与射线计算的对象，是primitives, entities, 或者 features的集合，比如说Scene中有一些辅助性的对象，比如坐标轴，目标点entity和观察点模型等等。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.kfgis.site/blog/2019/10/08/tongshifenxi/" data-id="ck1hpqo1q000frok841bfjmpc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cesium/">Cesium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/通视分析/">通视分析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-dixingkaiwa2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/08/dixingkaiwa2/" class="article-date">
  <time datetime="2019-10-08T08:26:00.000Z" itemprop="datePublished">2019-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/08/dixingkaiwa2/">Cesium-地形开挖-任意多边形开挖</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>“任意多边形地形开挖” 是“地形开挖”的补充篇，在这节里，我们介绍关于如何使用任意多边形对地形进行开挖，同时，由于有不少小伙伴也咨询了关于“地形开挖”篇后序内容中的填充地形的效果，之前没放出来，是想让小伙伴有个思考的过程，现在放出来，也是提供一种解决方法。</p>
</blockquote>
<p><strong>效果图</strong><br><img src="https://images.xiaozhuanlan.com/photo/2019/3f3231aee57663b1b582c46da05c2cb8.png" alt></p>
<p>直接上代码说明方法</p>
<p>1、使用鼠标交互事件，采集需要开挖的范围</p>
<p><strong>注：</strong> 这里要特别注意一点，为了下面的计算 ClippingPlane 方便，采集点顺序最好是 <strong>逆时针</strong>，如果点集的组织是顺时针，需要首先逆序成逆时针，关于如果判断一个点集是否是顺时针或者是逆时针，可以用向量法求多边形面积的方式，如果为正，则为顺时针，否者为逆时针。或者使用JS插件计算，比如turf.js。<br><img src="https://images.xiaozhuanlan.com/photo/2019/392125ffad2d954866d4f0dc738f19b7.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var points = [</span><br><span class="line">    new Cesium.Cartesian3(-1715292.6999753984, 4993153.157628936, 3566663.752912529),</span><br><span class="line">    new Cesium.Cartesian3(-1715285.8150713604, 4993167.072601330,3566647.6921528564),</span><br><span class="line">    new Cesium.Cartesian3(-1715286.5985765400, 4993181.309761941, 3566627.519787549),</span><br><span class="line">    new Cesium.Cartesian3(-1715299.0249209427, 4993191.177501195, 3566607.861264360),</span><br><span class="line">    new Cesium.Cartesian3(-1715349.5762367432, 4993176.675656664, 3566603.878289345),</span><br><span class="line">    new Cesium.Cartesian3(-1715375.5538853381, 4993159.990032478, 3566614.671147202),</span><br><span class="line">    new Cesium.Cartesian3(-1715370.1945772346, 4993141.041835706, 3566643.580587877),</span><br><span class="line">    new Cesium.Cartesian3(-1715359.7019716015, 4993131.063945592, 3566662.468046927),</span><br><span class="line">    new Cesium.Cartesian3(-1715321.9141253997, 4993137.762602262, 3566671.205164391)</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>2、根据点集计算 ClippingPlane （这个计算方式来源于官网示例）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var pointsLength = points.length;</span><br><span class="line">var clippingPlanes = []; // 存储ClippingPlane集合</span><br><span class="line">for (var i = 0; i &lt; pointsLength; ++i) &#123;</span><br><span class="line">  var nextIndex = (i + 1) % pointsLength;</span><br><span class="line">  var midpoint = Cesium.Cartesian3.add(points[i], points[nextIndex], new Cesium.Cartesian3());</span><br><span class="line">  midpoint = Cesium.Cartesian3.multiplyByScalar(midpoint, 0.5, midpoint);</span><br><span class="line"></span><br><span class="line">  var up = Cesium.Cartesian3.normalize(midpoint, new Cesium.Cartesian3());</span><br><span class="line">  var right = Cesium.Cartesian3.subtract(points[nextIndex], midpoint, new Cesium.Cartesian3());</span><br><span class="line">  right = Cesium.Cartesian3.normalize(right, right);</span><br><span class="line"></span><br><span class="line">  var normal = Cesium.Cartesian3.cross(right, up, new Cesium.Cartesian3());</span><br><span class="line">  normal = Cesium.Cartesian3.normalize(normal, normal);</span><br><span class="line"></span><br><span class="line">  var originCenteredPlane = new Cesium.Plane(normal, 0.0);</span><br><span class="line">  var distance = Cesium.Plane.getPointDistance(originCenteredPlane, midpoint);</span><br><span class="line"></span><br><span class="line">  clippingPlanes.push(new Cesium.ClippingPlane(normal, distance));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、赋值给globe的 clippingPlanes 属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">viewer.scene.globe.clippingPlanes = new Cesium.ClippingPlaneCollection(&#123;</span><br><span class="line">  planes: clippingPlanes,</span><br><span class="line">  edgeWidth: 1.0,</span><br><span class="line">  edgeColor: Cesium.Color.WHITE</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面就是填充地形的代码（比较简单，思想就是插值计算地形高度，绘制多边形）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// 多边形每个顶点的坐标</span><br><span class="line">var points = [];</span><br><span class="line"></span><br><span class="line">// 依次计算顶点与下个顶点之间组成的线段，中间按照精度大小插值n个点，然后计算每个点的地形高度</span><br><span class="line">var promise = calHeight(points[i], points[i+1], n); // 返回promise对象</span><br><span class="line"></span><br><span class="line">// 待所有的计算完毕后，处理坐标点，构造多边形</span><br><span class="line">Promise.all([promise1, promise2, ...]).then(data =&gt; &#123;</span><br><span class="line">    var positons = Array.prototype.concat.apply([], data); // 数组降维</span><br><span class="line">    var hierarchy = [];</span><br><span class="line">    positons.forEach(element =&gt; &#123;</span><br><span class="line">        hierarchy.push(Cesium.Math.toDegrees(element.longitude));</span><br><span class="line">        hierarchy.push(Cesium.Math.toDegrees(element.latitude));</span><br><span class="line">        hierarchy.push(element.height);</span><br><span class="line">    &#125;);</span><br><span class="line">    viewer.entities.add(&#123;</span><br><span class="line">        polygon: &#123;</span><br><span class="line">            hierarchy: Cesium.Cartesian3.fromDegreesArrayHeights(hierarchy),</span><br><span class="line">            material: new Cesium.ImageMaterialProperty(&#123;</span><br><span class="line">                image: &quot;../images/box.jpg&quot;</span><br><span class="line">            &#125;),</span><br><span class="line">            closeTop: false, // 这个要设置为false</span><br><span class="line">            extrudedHeight: 0,</span><br><span class="line">            perPositionHeight: true // 这个要设置true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>插值、计算坐标点高度（如果不加载地形的话，这步可以省略）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function calHeight(fromPoint, endPoint, count) &#123;</span><br><span class="line">    var positions = [];</span><br><span class="line">    for (var i = 0; i &lt;= count; i++) &#123;</span><br><span class="line">        var cart = Cesium.Cartesian3.lerp(fromPoint, endPoint, i / count, new Cesium.Cartesian3());</span><br><span class="line">        positions.push(Cesium.Cartographic.fromCartesian(cart));</span><br><span class="line">    &#125;</span><br><span class="line">    return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        var promise = Cesium.sampleTerrainMostDetailed(terrainProvider, positions);</span><br><span class="line">        Cesium.when(promise, function (updatedPositions) &#123;</span><br><span class="line">            resolve(updatedPositions);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.kfgis.site/blog/2019/10/08/dixingkaiwa2/" data-id="ck1hpqo140000rok8uik8tpb7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cesium/">Cesium</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/地形开挖/">地形开挖</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cesium/">Cesium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/剖面分析/">剖面分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/地形开挖/">地形开挖</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/测量/">测量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/通视分析/">通视分析</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Cesium/" style="font-size: 20px;">Cesium</a> <a href="/tags/剖面分析/" style="font-size: 10px;">剖面分析</a> <a href="/tags/地形开挖/" style="font-size: 10px;">地形开挖</a> <a href="/tags/测量/" style="font-size: 10px;">测量</a> <a href="/tags/通视分析/" style="font-size: 10px;">通视分析</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/10/08/celiang/">Cesium-测量</a>
          </li>
        
          <li>
            <a href="/2019/10/08/poumianfenxi/">Cesium-剖面分析</a>
          </li>
        
          <li>
            <a href="/2019/10/08/tongshifenxi/">Cesium-通视分析</a>
          </li>
        
          <li>
            <a href="/2019/10/08/dixingkaiwa2/">Cesium-地形开挖-任意多边形开挖</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 咖啡GIS<br>
      <p>关于博主：咖啡GIS，12年毕业于武汉理工大学GIS专业，毕业后一直从事WebGIS二、三维开发，熟悉LeafLet、OpenLaryes、Cesium等开源框架，在GIS数据采集、制作、项目开发方面有一定的项目经验，并从事过房产、气象、智慧社区等行业，有咨询、交流、合作请联系博主QQ：2034146498</p>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">所有文章</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>